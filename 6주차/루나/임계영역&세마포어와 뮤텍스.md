## Critical Section(임계 영역)

> 운영체제에서 여러 프로세스가 데이터를 공유하면서 수행될 때 **각 프로세스에서 공유 자원에 접근하는 프로그램 코드 부분**을 의미한다.
>

다중 프로그래밍 시스템에서 `여러 프로세스들이 공유하고 있는 자원을 한 시점에 하나의 프로세스만 접근할 수 있게 하는 영역, 공통 변수 구역을` **임계 구역**이라 한다.

프로세스간에 공유자원을 접근하는데 있어서 문제가 발생하지 않도록 **공유 자원의 독점을 보장**해줘야 하는 영역이다.

임계 영역 문제를 해결하기 위해서는 아래의 3가지 조건을 충족해야한다.

***⇒ 상호 배제를 구현할 수 있음..!***

- **Mutual Exclusion (상호 배제)**
    - 한 프로세스가 자신의 ciritical section이면 다른 프로세스들은 ciritical section에 진입할 수 없다.
- **Progress (진행)**
    - 아무도 critical section에 있지 않다면, 진입하고자 하는 프로세스를 진입하게 해줘야 한다.
    - 즉 **ciritical section에 아무도 진입하지 못하면 안되며** 다음에 어떤 프로세스가 ciritical section에 진입해야 하는지는 유한한 시간에 결정되어야 한다.
- **Bounded Waiting (유한 대기)**
    - 프로세스가 ciritical section에 집입하기 위해 무한정으로 기다리는 현상(Starvation)이 발생해서는 안된다.

## 동시 접근 문제를 해결하는 방법

임계 영역의 동시 접근 문제를 해결하기 위한 방법으로는 Lock, 세마포어, 모니터 등이 있다.

### 세마포어

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/478aea45-212d-41c9-95b7-8f1e40c4a4dd/Untitled.png)

공유자원을 여러 프로세스가 동시에 접근하는 것을 막기 위해 사용하는 방법

화장실 예시

- 화장실이 여러개 있고, 빈 칸 개수를 확인할 수 있다
- 화장실을 가고싶으면 빈 칸 개수를 확인하고 1개 이상이면 사용한다
- 화장실을 가고싶은데 빈 칸 개수가 0개이면 1개 이상이 될 때 까지 대기한다

→ 공통으로 관리하는 하나의 값(integer value)을 통해 상호 배제를 달성한다

- 세마포어 P, V 연산
    - S : 공유자원에 접근가능한 프로세스의 개수
        - 이진 세마포어(binary semaphore) : 세마포어 값이 0 또는 1의 값만 만들 수 있다(한번에 접근가능한 프로세스 개수가 1개일 경우)
        - 계수 세마포어(counting semaphore) : 2 이상의 값도 가질 수 있는 경우
    - P (try를 의미, acquire()) ****: 임계 구역에 들어가기 전에 수행하는 연산 → 프로세스의 진입 여부 결정
        - 프로세스가 임계구역에 들어가기 전에 수행되고(try), **세마포어 값을 감소**
          시킨다.
        - 감소 후 값이 음수가 되면 해당 프로세스를 List(레디큐)에 추가한 후, 함수를 호출한 프로세스는 Lock된다.
            - 세마포어 값 > 0 : 프로세스 접근 허용, 1을 감소함
            - 세마포어값 ≤ 0 : 프로세스 접근 금지.
    - V (increment를 의미, release()): 임계 구역에서 나올 때 수행하는 연산 → 자원 반남 알림, 대기 중인 프로세스 신호
        - 작업이 끝나고 프로세스나 쓰레드가 임계구역에서 나갈때는 나올 때 **세마포어 값을 증가**
        - 만약 세마포어 값이 음수이면, List(레디큐)에 있던 Lock 걸린 프로세스를 하나를 꺼내어 임계구역을 수행할 수 있도록 해준다.

  ⇒ P와 V연산은 원자성을 만족해야 하며, 한 프로세스나 쓰레드에서 S값을 변경하는 동안에는 다른 프로세스나 쓰레드가 동시에 접근해서 변경할 수 없다.


### 뮤텍스

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/f7f7d237-df62-425e-a7cf-a7d78d85cf22/Untitled.png)

임계 구역을 가진 스레드들의 실행시간이 서로 겹치지 않고 각각 단독으로 실행되게 하는 기술

- 다중 프로세스들의 공유 리소스에 대한 접근을 조율하기 위해 `locking`과 `unlocking`을 사용한다.
- 이진 세마포어와 같이 초기값을 1과 0으로 가진다.
    - 임계영역에 들어갈 때 락(lock)을 걸어 다른 프로세스(혹은 쓰레드)가 접근하지 못하도록 하고, 임계영역에서 나와 해당 락을 해제(unlock) 한다.
- 화장실 예시
    - 화장실이 하나이고, 이를 이용하기 위해 열쇠가 필요한 경우
    - 화장실을 가고싶은데 열쇠가 있으면 아무도 화장실에 없다는 뜻이고, 그렇기 때문에 사용할 수 있다
    - 화장실을 가고싶은데 열쇠가 없으면 누군가 화장실을 사용하고 있다는 뜻이고, 그렇기 때문에 사용할 수 없다
    - 다른 사람들이 와도 열쇠가 없으면 줄을 서야하고, 열쇠가 생기면 차례대로 화장실을 사용한다

  → 스레드/프로세스에 의해 공유될 수 있는 열쇠라는 object를 통해 상호 배제를 달성한다

- Lock & Unlock
    - Lock : 임계 구역에 들어갈 권한을 얻음
        - 만약 다른 프로세스/스레드가 임계 구역 수행 중이면 종료할 때까지 대기
    - Unlock : 임계 구역을 모두 사용했음을 알림
        - 대기 중인 다른 프로세스/스레드가 임계 구역에 진입할 수 있음

**뮤텍스 알고리즘**

1. **데커(Dekker) 알고리즘**

   flag와 turn 변수를 통해 임계 구역에 들어갈 프로세스/스레드를 결정하는 방식

    - flag : 프로세스 중 누가 임계영역에 진입할 것인지 나타내는 변수
    - turn : 누가 임계구역에 들어갈 차례인지 나타내는 변수

    ```java
    while(true) {
        flag[i] = true; // 프로세스 i가 임계 구역 진입 시도
        while(flag[j]) { // 프로세스 j가 현재 임계 구역에 있는지 확인
            if(turn == j) { // j가 임계 구역 사용 중이면
                flag[i] = false; // 프로세스 i 진입 취소
                while(turn == j); // turn이 j에서 변경될 때까지 대기
                flag[i] = true; // j turn이 끝나면 다시 진입 시도
            }
        }
    }
    
    // ------- 임계 구역 ---------
    
    turn = j; // 임계 구역 사용 끝나면 turn을 넘김
    flag[i] = false; // flag 값을 false로 바꿔 임계 구역 사용 완료를 알림
    ```

2. **피터슨(Peterson) 알고리즘**

   데커와 유사하지만, 상대방 프로세스/스레드에게 진입 기회를 양보하는 것에 차이가 있음

    ```java
    while(true) {
        flag[i] = true; // 프로세스 i가 임계 구역 진입 시도
        turn = j; // 다른 프로세스에게 진입 기회 양보
        while(flag[j] && turn == j) { // 다른 프로세스가 진입 시도하면 대기
        }
    }
    
    // ------- 임계 구역 ---------
    
    flag[i] = false; // flag 값을 false로 바꿔 임계 구역 사용 완료를 알림
    ```

3. **제과점(Bakery) 알고리즘**

   여러 프로세스/스레드에 대한 처리가 가능한 알고리즘. 가장 작은 수의 번호표를 가지고 있는 프로세스가 임계 구역에 진입한다.

    ```java
    while(true) {
        
        isReady[i] = true; // 번호표 받을 준비
        number[i] = max(number[0~n-1]) + 1; // 현재 실행 중인 프로세스 중에 가장 큰 번호 배정 
        isReady[i] = false; // 번호표 수령 완료
        
        for(j = 0; j < n; j++) { // 모든 프로세스 번호표 비교
            while(isReady[j]); // 비교 프로세스가 번호표 받을 때까지 대기
            while(number[j] && number[j] < number[i] && j < i);
            
            // 프로세스 j가 번호표 가지고 있어야 함
            // 프로세스 j의 번호표 < 프로세스 i의 번호표
        }
    }
    
    // ------- 임계 구역 ---------
    
    number[i] = 0; // 임계 구역 사용 종료
    ```


## **세마포어와 뮤텍스의 차이**

![https://user-images.githubusercontent.com/48278519/143730181-c9b26c7e-9b08-4e97-891e-1b00c56f49d3.png](https://user-images.githubusercontent.com/48278519/143730181-c9b26c7e-9b08-4e97-891e-1b00c56f49d3.png)

- 뮤텍스는 화장실이 하나밖에 없는 식당이다.
    - 화장실을 가기 위해서는 카운터에서 열쇠를 받아가야 하는데, 카운터에 키가 있으면 화장실에 사람이 없다는 뜻이기 때문에 바로 화장실로 갈 수 있다.
    - 반면 카운터에 키가 없는 경우 현재 화장실을 사용하고 있는 사람이 나올때까지 계속해서 기다려야 한다.
- 화장실을 이용하는 사람은 **프로세스 or 스레드** 이며 화장실은 공유자원, 화장실 키는 공유자원에 접근하기 위해 필요한 어떤 **오브젝트** 라고 생각할 수 있다.
- **뮤텍스는 Key에 해당하는 어떤 오브젝트가 있으며 이 오브젝트를 소유한 스레드or프로세스 만이 공유자원에 접근이 가능하다.**

![https://user-images.githubusercontent.com/48278519/143730385-79b35bc9-bbce-4ed6-a6fa-2b980fa8c857.png](https://user-images.githubusercontent.com/48278519/143730385-79b35bc9-bbce-4ed6-a6fa-2b980fa8c857.png)

- 세마포어는 화장실이 여러칸으로 되어있고, 화장실 입구에는 현재 화장실의 빈 칸 개수를 보여주는 전광판이 있는 상태아다.
    - 화장실이 가고 싶을 때, 전광판에 쓰여있는 빈 화장실 개수를 확인하고 1 이상이면 빈칸 개수를 뺀 다음 화장실로 입장한다.
    - 그리고 나올 때 빈칸 개수를 하나 더해준다.
- 모든 칸에 사람들이 들어갔을 경우, 화장실에 들어가고자 하는 사람이 있다면 빈칸 개수가 1이 될 때까지 기다렸다가 1이 되었을 때 다시 1을 뺀 다음 화장실을 사용한다.
- 이처럼 세마포어는 **공통으로 관리하는 하나의 값을 이용해 상호배제를 달성한**다.

뮤텍스:  한 쓰레드, 프로세스에 의해 소유될 수 있는 Key🔑를 기반으로 한 상호배제기법

세마포어 : 현재 공유자원에 접근할 수 있는 쓰레드, 프로세스의 수를 나타내는 값을 두어 상호배제를 달성하는 기법